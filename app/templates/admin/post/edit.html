{% extends 'admin/base.html' %}

{% block title %}编辑文章 - 管理后台{% endblock %}

{% block page_title %}编辑文章{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css" rel="stylesheet" />
<style>
    .CodeMirror {
        height: 400px;
    }
    .editor-toolbar {
        border-radius: 0;
    }
    .form-check-input {
        margin-top: 0.3rem;
    }
    
    /* 修复页面整体背景色 */
    html.dark-theme .container-fluid {
        background-color: #121212 !important;
    }
    
    html.dark-theme .main-content {
        background-color: #121212 !important;
    }
    
    html.dark-theme .py-4 {
        background-color: #121212 !important;
    }
    
    /* 修复卡片在暗黑模式下的样式 */
    html.dark-theme .card {
        background-color: #1e1e1e !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .card-body {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .form-control,
    html.dark-theme .form-select {
        background-color: #272727 !important;
        border-color: #333 !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .form-text {
        color: #888 !important;
    }
    
    html.dark-theme .form-check-label {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .form-check-input {
        background-color: #272727 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
    }
    
    html.dark-theme .btn-secondary {
        background-color: #272727 !important;
        border-color: #333 !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .btn-secondary:hover {
        background-color: #323232 !important;
        border-color: #444 !important;
    }
    
    /* 修复模态框在暗黑模式下的样式 */
    html.dark-theme .modal-content {
        background-color: #1e1e1e !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .modal-header,
    html.dark-theme .modal-footer {
        border-color: #333 !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .modal-title {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%) !important;
    }
    
    /* 修复编辑器在暗黑模式下的样式 */
    html.dark-theme .editor-toolbar a {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .editor-toolbar a:hover,
    html.dark-theme .editor-toolbar a.active {
        background: #333 !important;
        border-color: #444 !important;
    }
    
    html.dark-theme .editor-toolbar {
        background-color: #272727 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .CodeMirror {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .editor-preview-side {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .editor-statusbar {
        color: #888 !important;
        background-color: #272727 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .CodeMirror-cursor {
        border-left-color: #fff !important;
    }
    
    html.dark-theme .CodeMirror-selected {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    html.dark-theme .CodeMirror-line {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .cm-header {
        color: #569cd6 !important;
    }
    
    html.dark-theme .cm-quote {
        color: #608b4e !important;
    }
    
    html.dark-theme .cm-keyword {
        color: #569cd6 !important;
    }
    
    html.dark-theme .cm-link {
        color: #569cd6 !important;
    }
    
    html.dark-theme .cm-string {
        color: #ce9178 !important;
    }
    
    html.dark-theme .cm-comment {
        color: #608b4e !important;
    }
    
    /* 预览内容样式 */
    .preview-container {
        padding: 20px;
    }
    
    .preview-title {
        font-size: 2rem;
        margin-bottom: 1rem;
    }
    
    .preview-body {
        font-size: 1rem;
        line-height: 1.6;
    }
    
    .preview-body img {
        max-width: 100%;
        height: auto;
    }
    
    .preview-body h1, .preview-body h2, .preview-body h3, 
    .preview-body h4, .preview-body h5, .preview-body h6 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .preview-body blockquote {
        border-left: 4px solid #ddd;
        padding-left: 1rem;
        color: #666;
        margin-left: 0;
    }
    
    .preview-body pre {
        background-color: #f8f8f8;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
    }
    
    .preview-body code {
        background-color: #f8f8f8;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
    }
    
    /* 暗黑模式下的预览样式 */
    html.dark-theme .preview-body {
        color: #e0e0e0;
    }
    
    html.dark-theme .preview-body blockquote {
        border-left-color: #444;
        color: #aaa;
    }
    
    html.dark-theme .preview-body pre,
    html.dark-theme .preview-body code {
        background-color: #2a2a2a;
        color: #e0e0e0;
    }
    
    /* 修复模态框内预览内容的暗黑模式样式 */
    html.dark-theme #preview-content.dark-theme .preview-body {
        color: #e0e0e0;
    }
    
    html.dark-theme #preview-content.dark-theme .preview-title {
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="post" action="{{ url_for('admin_dashboard.post.edit', post_id=post.id) }}" id="post-form" novalidate>
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control") }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.title.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            {{ form.content(class="form-control", rows=10) }}
                            {% if form.content.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.content.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">支持 Markdown 格式</div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.summary.label(class="form-label") }}
                            {{ form.summary(class="form-control", rows=3) }}
                            {% if form.summary.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.summary.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">如果不填写，将自动截取正文前 150 个字符作为摘要</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.category_id.label(class="form-label") }}
                                    {{ form.category_id(class="form-select") }}
                                    {% if form.category_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.category_id.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.status.label(class="form-label") }}
                                    {{ form.status(class="form-select") }}
                                    {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.status.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.tags.label(class="form-label") }}
                            {{ form.tags(class="form-select", multiple=True) }}
                            {% if form.tags.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.tags.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">可以选择多个标签，也可以输入新标签</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.is_sticky(class="form-check-input") }}
                                    {{ form.is_sticky.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.is_private(class="form-check-input") }}
                                    {{ form.is_private.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.can_comment(class="form-check-input") }}
                                    {{ form.can_comment.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin_dashboard.post.index') }}" class="btn btn-secondary">取消</a>
                            <div>
                                <button type="button" id="preview-btn" class="btn btn-outline-secondary me-2">预览</button>
                                <button type="button" id="direct-submit-btn" class="btn btn-success me-2">直接提交</button>
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 预览模态框 -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭" id="previewCloseBtn"></button>
            </div>
            <div class="modal-body" id="preview-content">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化 Select2
        $('#tags').select2({
            theme: 'bootstrap-5',
            placeholder: '选择或输入标签',
            allowClear: true,
            tags: true,
            tokenSeparators: [',', ' '],
            width: '100%'
        });
        
        // 检查是否为暗黑模式
        const isDarkMode = document.documentElement.classList.contains('dark-theme');
        
        // 初始化 SimpleMDE
        var simplemde = new SimpleMDE({
            element: document.getElementById("content"),
            spellChecker: false,
            autosave: {
                enabled: true,
                uniqueId: "post-edit-" + {{ post.id }},
                delay: 1000,
            },
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                "link", "image", "table", "code", "|",
                "preview", "side-by-side", "fullscreen", "|",
                "guide"
            ],
            status: ["autosave", "lines", "words", "cursor"]
        });
        
        // 如果是暗黑模式，强制应用暗黑模式样式
        if (isDarkMode) {
            const cmEditor = simplemde.codemirror;
            cmEditor.getWrapperElement().classList.add('cm-s-dark');
            document.querySelector('.editor-toolbar').classList.add('dark-theme');
            document.querySelector('.editor-preview-side').classList.add('dark-theme');
        }
        
        // 监听主题切换
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    const isDark = document.documentElement.classList.contains('dark-theme');
                    const cmEditor = simplemde.codemirror;
                    const toolbar = document.querySelector('.editor-toolbar');
                    const preview = document.querySelector('.editor-preview-side');
                    
                    if (isDark) {
                        cmEditor.getWrapperElement().classList.add('cm-s-dark');
                        toolbar.classList.add('dark-theme');
                        preview.classList.add('dark-theme');
                    } else {
                        cmEditor.getWrapperElement().classList.remove('cm-s-dark');
                        toolbar.classList.remove('dark-theme');
                        preview.classList.remove('dark-theme');
                    }
                }
            });
        });
        
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
        
        // 处理直接提交按钮事件
        document.getElementById('direct-submit-btn').addEventListener('click', function() {
            // 将SimpleMDE的内容同步到原始textarea
            var content = simplemde.value();
            
            // 如果内容为空，显示错误
            if (!content.trim()) {
                showCustomNotification('文章内容不能为空', 'error');
                return;
            }
            
            document.getElementById('content').value = content;
            console.log('直接提交 - 内容已同步到表单，长度:', content.length);
            
            // 显示textarea确保内容被提交
            document.getElementById('content').style.display = 'block';
            
            // 直接提交表单
            console.log('直接提交表单...');
            // 查找表单中的原生提交按钮并点击它
            var submitButton = document.querySelector('form .btn-primary[type="submit"]');
            if(submitButton) {
                submitButton.click();
            } else {
                // 后备方案：直接提交表单
                document.getElementById('post-form').submit();
            }
        });
        
        // 表单提交前处理
        document.getElementById('post-form').addEventListener('submit', function(e) {
            // 将编辑器内容同步到textarea
            var content = simplemde.value();
            document.getElementById('content').value = content;
            document.getElementById('content').style.display = 'block';
            
            // 如果内容为空，阻止表单提交并显示错误
            if (!content.trim()) {
                e.preventDefault();
                showCustomNotification('文章内容不能为空', 'error');
                return false;
            }
            
            // 正常提交表单
            return true;
        });

        // 预览功能
        document.getElementById('preview-btn').addEventListener('click', function() {
            try {
                // 获取编辑器内容
                const content = simplemde.value();
                
                // 获取标题
                const title = document.getElementById('title').value || '无标题';
                
                // 设置预览内容
                const previewContent = document.getElementById('preview-content');
                
                // 使用marked解析Markdown
                const htmlContent = marked.parse(content);
                
                // 添加到预览区域
                previewContent.innerHTML = `
                    <div class="preview-container">
                        <h1 class="preview-title">${title}</h1>
                        <hr>
                        <div class="preview-body">${htmlContent}</div>
                    </div>
                `;
                
                // 给预览内容添加样式
                const isDarkMode = document.documentElement.classList.contains('dark-theme');
                if (isDarkMode) {
                    previewContent.classList.add('dark-theme');
                } else {
                    previewContent.classList.remove('dark-theme');
                }
                
                // 显示预览模态框
                const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                previewModal.show();
            } catch (error) {
                console.error('预览生成错误:', error);
                alert('预览生成失败: ' + error.message);
            }
        });
    });
</script>
{% endblock %} 