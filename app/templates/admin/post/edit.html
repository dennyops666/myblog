{% extends 'admin/base.html' %}

{% block title %}编辑文章 - 管理后台{% endblock %}

{% block page_title %}编辑文章{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css" rel="stylesheet" />
<style>
    .CodeMirror {
        height: 400px;
}
.editor-toolbar {
    border-radius: 0;
}
    .form-check-input {
        margin-top: 0.3rem;
}
    
    /* 修复页面整体背景色 */
    html.dark-theme .container-fluid {
        background-color: #121212 !important;
    }
    
    html.dark-theme .main-content {
        background-color: #121212 !important;
    }
    
    html.dark-theme .py-4 {
        background-color: #121212 !important;
    }
    
    /* 修复卡片在暗黑模式下的样式 */
    html.dark-theme .card {
        background-color: #1e1e1e !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .card-body {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .form-control,
    html.dark-theme .form-select {
        background-color: #272727 !important;
        border-color: #333 !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .form-text {
        color: #888 !important;
    }
    
    html.dark-theme .form-check-label {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .form-check-input {
        background-color: #272727 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .form-check-input:checked {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
    }
    
    html.dark-theme .btn-secondary {
        background-color: #272727 !important;
        border-color: #333 !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .btn-secondary:hover {
        background-color: #323232 !important;
        border-color: #444 !important;
    }
    
    /* 修复模态框在暗黑模式下的样式 */
    html.dark-theme .modal-content {
        background-color: #1e1e1e !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .modal-header,
    html.dark-theme .modal-footer {
        border-color: #333 !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .modal-title {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%) !important;
    }
    
    /* 修复编辑器在暗黑模式下的样式 */
    html.dark-theme .editor-toolbar a {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .editor-toolbar a:hover,
    html.dark-theme .editor-toolbar a.active {
        background: #333 !important;
        border-color: #444 !important;
    }
    
    html.dark-theme .editor-toolbar {
        background-color: #272727 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .CodeMirror {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .editor-preview-side {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .editor-statusbar {
        color: #888 !important;
        background-color: #272727 !important;
        border-color: #333 !important;
    }
    
    html.dark-theme .CodeMirror-cursor {
        border-left-color: #fff !important;
    }
    
    html.dark-theme .CodeMirror-selected {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    html.dark-theme .CodeMirror-line {
        color: #e0e0e0 !important;
    }
    
    html.dark-theme .cm-header {
        color: #569cd6 !important;
    }
    
    html.dark-theme .cm-quote {
        color: #608b4e !important;
    }
    
    html.dark-theme .cm-keyword {
        color: #569cd6 !important;
    }
    
    html.dark-theme .cm-link {
        color: #569cd6 !important;
    }
    
    html.dark-theme .cm-string {
        color: #ce9178 !important;
    }
    
    html.dark-theme .cm-comment {
        color: #608b4e !important;
    }
    
    /* 预览内容样式 */
    .preview-container {
        padding: 20px;
    }
    
    .preview-title {
        font-size: 2rem;
        margin-bottom: 1rem;
    }
    
    .preview-body {
        font-size: 1rem;
        line-height: 1.6;
    }
    
    .preview-body img {
        max-width: 100%;
        height: auto;
    }
    
    .preview-body h1, .preview-body h2, .preview-body h3, 
    .preview-body h4, .preview-body h5, .preview-body h6 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .preview-body blockquote {
        border-left: 4px solid #ddd;
        padding-left: 1rem;
        color: #666;
        margin-left: 0;
    }
    
    .preview-body pre {
        background-color: #f8f8f8;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
    }
    
    .preview-body code {
        background-color: #f8f8f8;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
    }
    
    /* 暗黑模式下的预览样式 */
    html.dark-theme .preview-body {
        color: #e0e0e0;
    }
    
    html.dark-theme .preview-body blockquote {
        border-left-color: #444;
        color: #aaa;
    }
    
    html.dark-theme .preview-body pre,
    html.dark-theme .preview-body code {
        background-color: #2a2a2a;
        color: #e0e0e0;
    }
    
    /* 修复模态框内预览内容的暗黑模式样式 */
    html.dark-theme #preview-content.dark-theme .preview-body {
        color: #e0e0e0;
    }
    
    html.dark-theme #preview-content.dark-theme .preview-title {
        color: #fff;
    }
    
    /* 自定义预览对话框样式 */
    #custom-preview-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
    }
    
    #custom-preview-dialog {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
    }
    
    #custom-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    #custom-preview-body {
        padding: 20px;
        overflow-y: auto;
        max-height: 65vh;
    }
    
    #custom-preview-footer {
        padding: 15px;
        text-align: right;
        border-top: 1px solid #dee2e6;
    }
    
    #custom-preview-close-x {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        margin: 0;
    }
    
    html.dark-theme #custom-preview-dialog {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    
    html.dark-theme #custom-preview-header,
    html.dark-theme #custom-preview-footer {
        border-color: #333;
    }
    
    html.dark-theme #custom-preview-close-x {
        color: #e0e0e0;
    }
    
    html.dark-theme #custom-preview-close {
        background-color: #272727;
        border-color: #333;
        color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
                        <div class="card">
                            <div class="card-body">
        <form method="post" action="{{ url_for('admin_dashboard.post.edit', post_id=post.id) }}" id="post-form" novalidate>
            <div class="mb-3">
                                    {{ form.title.label(class="form-label") }}
                {{ form.title(class="form-control") }}
                                    {% if form.title.errors %}
                <div class="invalid-feedback d-block">
                                        {% for error in form.title.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

            <div class="mb-3">
                                    {{ form.content.label(class="form-label") }}
                {{ form.content(class="form-control", rows=10) }}
                                    {% if form.content.errors %}
                <div class="invalid-feedback d-block">
                                        {% for error in form.content.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                <div class="form-text">支持 Markdown 格式</div>
                                </div>
            
            <div class="mb-3">
                {{ form.summary.label(class="form-label") }}
                {{ form.summary(class="form-control", rows=3) }}
                {% if form.summary.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.summary.errors %}
                    {{ error }}
                    {% endfor %}
                            </div>
                {% endif %}
                <div class="form-text">如果不填写，将自动截取正文前 150 个字符作为摘要</div>
                    </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                                    {{ form.category_id.label(class="form-label") }}
                        {{ form.category_id(class="form-select") }}
                                    {% if form.category_id.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.category_id.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                    </div>
                <div class="col-md-6">
                    <div class="mb-3">
                                    {{ form.status.label(class="form-label") }}
                        {{ form.status(class="form-select") }}
                                    {% if form.status.errors %}
                        <div class="invalid-feedback d-block">
                                        {% for error in form.status.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                    </div>
                </div>
                                </div>

            <div class="mb-3">
                {{ form.tags.label(class="form-label") }}
                {{ form.tags(class="form-select", multiple=True) }}
                {% if form.tags.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.tags.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                <div class="form-text">可以选择多个标签，也可以输入新标签</div>
                                </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="form-check">
                        {{ form.is_sticky(class="form-check-input") }}
                        {{ form.is_sticky.label(class="form-check-label") }}
                                </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        {{ form.is_private(class="form-check-input") }}
                        {{ form.is_private.label(class="form-check-label") }}
                            </div>
                        </div>
                <div class="col-md-4">
                    <div class="form-check">
                        {{ form.can_comment(class="form-check-input") }}
                        {{ form.can_comment.label(class="form-check-label") }}
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('admin_dashboard.post.index') }}" class="btn btn-secondary">取消</a>
                <div>
                    <button type="button" id="preview-btn" class="btn btn-outline-secondary me-2">预览</button>
                    <button type="button" id="direct-submit-btn" class="btn btn-success me-2">直接提交</button>
                    {{ form.submit(class="btn btn-primary") }}
                    </div>
                </div>
            </form>
                </div>
            </div>
        </div>
        </div>
    </div>

<!-- 自定义预览对话框 -->
<div id="custom-preview-overlay">
    <div id="custom-preview-dialog">
        <div id="custom-preview-header">
            <h5 style="margin: 0">预览</h5>
            <button type="button" id="custom-preview-close-x">&times;</button>
            </div>
        <div id="custom-preview-body">
            <div style="text-align: center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            </div>
        <div id="custom-preview-footer">
            <button type="button" id="custom-preview-close" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    var simplemde;
    
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化自定义预览
        var previewOverlay = document.getElementById('custom-preview-overlay');
        var previewBody = document.getElementById('custom-preview-body');
        var previewCloseX = document.getElementById('custom-preview-close-x');
        var previewClose = document.getElementById('custom-preview-close');
        
        // 关闭预览函数
        function closePreview() {
            previewOverlay.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        // 绑定关闭按钮事件
        previewCloseX.addEventListener('click', closePreview);
        previewClose.addEventListener('click', closePreview);
        
        // 点击背景关闭
        previewOverlay.addEventListener('click', function(e) {
            if (e.target === previewOverlay) {
                closePreview();
            }
        });
        
        // ESC键关闭
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && previewOverlay.style.display === 'block') {
                closePreview();
            }
        });
        
        // 预览按钮事件
        document.getElementById('preview-btn').addEventListener('click', function() {
            // 获取编辑器内容
            var content = simplemde.value();
            
            // 如果内容为空，提示用户
            if (!content.trim()) {
                alert('请先输入文章内容');
                return;
            }
            
            // 获取标题
            var title = document.getElementById('title').value || '无标题';
            
            // 使用marked解析Markdown
            var htmlContent = marked.parse(content);
            
            // 设置预览内容
            previewBody.innerHTML = `
                <div class="preview-container">
                    <h1 class="preview-title">${title}</h1>
                    <hr>
                    <div class="preview-body">${htmlContent}</div>
                </div>
            `;
            
            // 显示自定义预览对话框
            previewOverlay.style.display = 'block';
            document.body.style.overflow = 'hidden'; // 防止背景滚动
            
            console.log('预览对话框已显示');
        });
        
        // 初始化 Select2
        $('#tags').select2({
            theme: 'bootstrap-5',
            placeholder: '选择或输入标签',
            allowClear: true,
            tags: true,
            tokenSeparators: [',', ' '],
            width: '100%'
        });
        
        // 检查是否为暗黑模式
        const isDarkMode = document.documentElement.classList.contains('dark-theme');
        
        // 初始化 SimpleMDE
        simplemde = new SimpleMDE({
            element: document.getElementById("content"),
        spellChecker: false,
            autosave: {
                enabled: true,
                uniqueId: "post-edit-" + {{ post.id }},
                delay: 1000,
        },
        toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                {
                    name: "custom-image",
                    action: function customFunction(editor){
                        // 创建并设置弹出对话框
                        var dialog = document.createElement('div');
                        dialog.className = "image-insert-dialog";
                        dialog.style.position = "fixed";
                        dialog.style.top = "0";
                        dialog.style.left = "0";
                        dialog.style.right = "0";
                        dialog.style.bottom = "0";
                        dialog.style.backgroundColor = "rgba(0,0,0,0.5)";
                        dialog.style.zIndex = "9999";
                        dialog.style.display = "flex";
                        dialog.style.alignItems = "center";
                        dialog.style.justifyContent = "center";
                        
                        // 创建对话框内容
                        var dialogContent = document.createElement('div');
                        dialogContent.className = "dialog-content";
                        dialogContent.style.background = "#fff";
                        dialogContent.style.borderRadius = "8px";
                        dialogContent.style.padding = "20px";
                        dialogContent.style.width = "400px";
                        dialogContent.style.maxWidth = "95%";
                        dialogContent.style.boxShadow = "0 4px 20px rgba(0,0,0,0.2)";
                        
                        // 添加标题
                        var title = document.createElement('h4');
                        title.style.marginTop = "0";
                        title.style.marginBottom = "20px";
                        title.textContent = "插入图片";
                        dialogContent.appendChild(title);
                        
                        // 创建模式选择区域
                        var modeContainer = document.createElement('div');
                        modeContainer.className = "mb-3";
                        
                        // 创建模式选择按钮组
                        var btnGroup = document.createElement('div');
                        btnGroup.className = "btn-group w-100 mb-3";
                        btnGroup.setAttribute("role", "group");
                        
                        // 上传模式单选按钮
                        var imgUploadRadio = document.createElement('input');
                        imgUploadRadio.type = "radio";
                        imgUploadRadio.className = "btn-check";
                        imgUploadRadio.name = "imgType_" + Date.now();
                        imgUploadRadio.id = "imgUpload_" + Date.now();
                        imgUploadRadio.checked = true;
                        
                        var imgUploadLabel = document.createElement('label');
                        imgUploadLabel.className = "btn btn-outline-primary";
                        imgUploadLabel.textContent = "上传图片";
                        imgUploadLabel.htmlFor = imgUploadRadio.id;
                        
                        // URL模式单选按钮
                        var imgUrlRadio = document.createElement('input');
                        imgUrlRadio.type = "radio";
                        imgUrlRadio.className = "btn-check";
                        imgUrlRadio.name = imgUploadRadio.name;
                        imgUrlRadio.id = "imgUrl_" + Date.now();
                        
                        var imgUrlLabel = document.createElement('label');
                        imgUrlLabel.className = "btn btn-outline-primary";
                        imgUrlLabel.textContent = "外部链接";
                        imgUrlLabel.htmlFor = imgUrlRadio.id;
                        
                        // 服务器图片模式单选按钮
                        var imgServerRadio = document.createElement('input');
                        imgServerRadio.type = "radio";
                        imgServerRadio.className = "btn-check";
                        imgServerRadio.name = imgUploadRadio.name;
                        imgServerRadio.id = "imgServer_" + Date.now();
                        
                        var imgServerLabel = document.createElement('label');
                        imgServerLabel.className = "btn btn-outline-primary";
                        imgServerLabel.textContent = "服务器图片";
                        imgServerLabel.htmlFor = imgServerRadio.id;
                        
                        // 添加按钮到按钮组
                        btnGroup.appendChild(imgUploadRadio);
                        btnGroup.appendChild(imgUploadLabel);
                        btnGroup.appendChild(imgUrlRadio);
                        btnGroup.appendChild(imgUrlLabel);
                        btnGroup.appendChild(imgServerRadio);
                        btnGroup.appendChild(imgServerLabel);
                        modeContainer.appendChild(btnGroup);
                        
                        // 创建上传文件区域
                        var uploadSection = document.createElement('div');
                        var uploadInput = document.createElement('div');
                        uploadInput.className = "mb-3";
                        
                        var imageFile = document.createElement('input');
                        imageFile.type = "file";
                        imageFile.className = "form-control";
                        imageFile.accept = "image/*";
                        
                        uploadInput.appendChild(imageFile);
                        uploadSection.appendChild(uploadInput);
                        
                        // 创建URL输入区域
                        var urlSection = document.createElement('div');
                        urlSection.style.display = "none";
                        
                        var urlInputContainer = document.createElement('div');
                        urlInputContainer.className = "mb-3";
                        
                        var imageUrl = document.createElement('input');
                        imageUrl.type = "text";
                        imageUrl.className = "form-control";
                        imageUrl.placeholder = "请输入图片URL";
                        
                        urlInputContainer.appendChild(imageUrl);
                        urlSection.appendChild(urlInputContainer);
                        
                        var altInputContainer = document.createElement('div');
                        altInputContainer.className = "mb-3";
                        
                        var imageAltText = document.createElement('input');
                        imageAltText.type = "text";
                        imageAltText.className = "form-control";
                        imageAltText.placeholder = "替代文本（可选）";
                        
                        altInputContainer.appendChild(imageAltText);
                        urlSection.appendChild(altInputContainer);
                        
                        // 创建服务器图片选择区域
                        var serverSection = document.createElement('div');
                        serverSection.style.display = "none";
                        
                        // 加载状态显示
                        var loadingDiv = document.createElement('div');
                        loadingDiv.className = "text-center py-3";
                        loadingDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div>';
                        serverSection.appendChild(loadingDiv);
                        
                        // 图片网格容器
                        var imageGrid = document.createElement('div');
                        imageGrid.className = "row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2 py-2";
                        imageGrid.style.maxHeight = "300px";
                        imageGrid.style.overflowY = "auto";
                        imageGrid.style.display = "none"; // 初始隐藏
                        serverSection.appendChild(imageGrid);
                        
                        // 无图片提示
                        var noImagesDiv = document.createElement('div');
                        noImagesDiv.className = "alert alert-info";
                        noImagesDiv.textContent = "服务器上没有可用的图片";
                        noImagesDiv.style.display = "none"; // 初始隐藏
                        serverSection.appendChild(noImagesDiv);
                        
                        // 错误提示
                        var errorDiv = document.createElement('div');
                        errorDiv.className = "alert alert-danger";
                        errorDiv.textContent = "加载图片失败，请重试";
                        errorDiv.style.display = "none"; // 初始隐藏
                        serverSection.appendChild(errorDiv);
                        
                        // 添加区域到主容器
                        modeContainer.appendChild(uploadSection);
                        modeContainer.appendChild(urlSection);
                        modeContainer.appendChild(serverSection);
                        dialogContent.appendChild(modeContainer);
                        
                        // 创建按钮区域
                        var btnContainer = document.createElement('div');
                        btnContainer.className = "d-flex justify-content-end";
                        
                        var cancelBtn = document.createElement('button');
                        cancelBtn.type = "button";
                        cancelBtn.className = "btn btn-secondary me-2";
                        cancelBtn.textContent = "取消";
                        
                        var insertBtn = document.createElement('button');
                        insertBtn.type = "button";
                        insertBtn.className = "btn btn-primary";
                        insertBtn.textContent = "插入";
                        
                        btnContainer.appendChild(cancelBtn);
                        btnContainer.appendChild(insertBtn);
                        dialogContent.appendChild(btnContainer);
                        
                        // 将对话框内容添加到对话框
                        dialog.appendChild(dialogContent);
                        
                        // 添加对话框到页面
                        document.body.appendChild(dialog);
                        
                        // 设置事件监听器
                        // 模式切换
                        imgUploadRadio.addEventListener('change', function() {
                            if(this.checked) {
                                uploadSection.style.display = "block";
                                urlSection.style.display = "none";
                                serverSection.style.display = "none";
                            }
                        });
                        
                        imgUrlRadio.addEventListener('change', function() {
                            if(this.checked) {
                                uploadSection.style.display = "none";
                                urlSection.style.display = "block";
                                serverSection.style.display = "none";
                            }
                        });
                        
                        imgServerRadio.addEventListener('change', function() {
                            if(this.checked) {
                                uploadSection.style.display = "none";
                                urlSection.style.display = "none";
                                serverSection.style.display = "block";
                                
                                // 加载服务器图片列表
                                loadServerImages();
                            }
                        });
                        
                        // 加载服务器图片函数
                        function loadServerImages() {
                            // 显示加载状态
                            loadingDiv.style.display = "block";
                            imageGrid.style.display = "none";
                            noImagesDiv.style.display = "none";
                            errorDiv.style.display = "none";
                            
                            // 发送请求获取图片列表
                            fetch('/admin/upload/images', {
                                method: 'GET',
                                credentials: 'same-origin',
                                headers: {
                                    'Accept': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`服务器返回错误: ${response.status} ${response.statusText}`);
                                }
                                const contentType = response.headers.get('content-type');
                                if (!contentType || !contentType.includes('application/json')) {
                                    throw new Error(`预期返回JSON格式，但实际返回: ${contentType}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                // 隐藏加载状态
                                loadingDiv.style.display = "none";
                                
                                if (data.success) {
                                    if (data.files && data.files.length > 0) {
                                        // 清空之前的内容
                                        imageGrid.innerHTML = '';
                                        
                                        // 遍历图片列表，创建图片卡片
                                        data.files.forEach(function(file) {
                                            var col = document.createElement('div');
                                            col.className = "col";
                                            
                                            var card = document.createElement('div');
                                            card.className = "card h-100 img-card";
                                            card.style.cursor = "pointer";
                                            
                                            var img = document.createElement('img');
                                            img.className = "card-img-top";
                                            img.src = file.url;
                                            img.alt = file.name;
                                            img.style.objectFit = "cover";
                                            img.style.height = "80px";
                                            
                                            var cardBody = document.createElement('div');
                                            cardBody.className = "card-body p-2";
                                            
                                            var fileName = document.createElement('p');
                                            fileName.className = "card-text small text-truncate mb-0";
                                            fileName.title = file.name;
                                            fileName.textContent = file.name;
                                            
                                            cardBody.appendChild(fileName);
                                            card.appendChild(img);
                                            card.appendChild(cardBody);
                                            col.appendChild(card);
                                            
                                            // 添加点击事件
                                            card.addEventListener('click', function() {
                                                // 插入选中的图片
                                                var cm = editor.codemirror;
                                                var imageUrl = file.url;
                                                var altText = file.name || '图片';
                                                
                                                // 插入markdown格式的图片
                                                var text = `![${altText}](${imageUrl})`;
                                                cm.replaceSelection(text);
                                                
                                                showCustomNotification('图片已插入', 'success');
                                                
                                                // 关闭对话框
                                                document.body.removeChild(dialog);
                                            });
                                            
                                            imageGrid.appendChild(col);
                                        });
                                        
                                        // 显示图片网格
                                        imageGrid.style.display = "flex";
                                    } else {
                                        // 显示无图片提示
                                        noImagesDiv.style.display = "block";
                                    }
                                } else {
                                    // 显示错误提示
                                    errorDiv.textContent = data.message || "加载图片失败，请重试";
                                    errorDiv.style.display = "block";
                                }
                            })
                            .catch(error => {
                                console.error('加载图片错误:', error);
                                loadingDiv.style.display = "none";
                                errorDiv.textContent = error.message || "加载图片失败，请重试";
                                errorDiv.style.display = "block";
                            });
                        }
                        
                        // 取消按钮
                        cancelBtn.addEventListener('click', function() {
                            document.body.removeChild(dialog);
                        });
                        
                        // 插入按钮
                        insertBtn.addEventListener('click', function() {
                            if (imgUploadRadio.checked) {
                                // 上传图片模式
                                if (!imageFile.files || imageFile.files.length === 0) {
                                    showCustomNotification('请选择要上传的图片', 'warning');
                                    return;
                                }
                                
                                var file = imageFile.files[0];
                                
                                // 显示上传中提示
                                showCustomNotification('正在上传图片，请稍候...', 'info');
                                
                                // 创建FormData对象
                                var formData = new FormData();
                                formData.append('file', file);
                                
                                // 发送请求
                                fetch('/admin/post/upload', {
                                    method: 'POST',
                                    body: formData,
                                    credentials: 'same-origin'
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if(data.url) {
                                        // 成功上传，插入图片
                                        var cm = editor.codemirror;
                                        var imageUrl = data.url;
                                        
                                        // 获取文件名，作为替代文本
                                        var altText = data.filename || '图片';
                                        
                                        // 插入markdown格式的图片
                                        var text = `![${altText}](${imageUrl})`;
                                        cm.replaceSelection(text);
                                        
                                        showCustomNotification('图片上传成功！', 'success');
                                    } else {
                                        showCustomNotification('图片上传失败: ' + (data.error || '未知错误'), 'error');
                                    }
                                })
                                .catch(error => {
                                    console.error('上传错误:', error);
                                    showCustomNotification('图片上传失败，请重试', 'error');
                                });
                            } else {
                                // 外部链接模式
                                var url = imageUrl.value.trim();
                                if (!url) {
                                    showCustomNotification('请输入图片URL', 'warning');
                                    return;
                                }
                                
                                // 获取替代文本
                                var altText = imageAltText.value.trim() || '图片';
                                
                                // 插入markdown格式的图片
                                var cm = editor.codemirror;
                                var text = `![${altText}](${url})`;
                                cm.replaceSelection(text);
                                
                                showCustomNotification('图片链接已插入', 'success');
                            }
                            
                            // 关闭对话框
                            document.body.removeChild(dialog);
                        });
                        
                        // ESC键关闭对话框
                        var escHandler = function(e) {
                            if (e.key === 'Escape') {
                                document.body.removeChild(dialog);
                                document.removeEventListener('keydown', escHandler);
                            }
                        };
                        document.addEventListener('keydown', escHandler);
                        
                        // 点击背景关闭对话框
                        dialog.addEventListener('click', function(e) {
                            if (e.target === dialog) {
                                document.body.removeChild(dialog);
                            }
                        });
                    },
                    className: "fa fa-picture-o",
                    title: "插入图片",
                },
                "link", "table", "code", "|",
                "preview", "side-by-side", "fullscreen", "|",
                "guide"
            ],
            status: ["autosave", "lines", "words", "cursor"]
        });
        
        // 如果是暗黑模式，强制应用暗黑模式样式
        if (isDarkMode) {
            const cmEditor = simplemde.codemirror;
            cmEditor.getWrapperElement().classList.add('cm-s-dark');
            document.querySelector('.editor-toolbar').classList.add('dark-theme');
            document.querySelector('.editor-preview-side').classList.add('dark-theme');
        }
        
        // 增强全屏模式处理
        var simplemdeFullScreenHandler = function() {
            var sidebar = document.querySelector('.sidebar');
            var navbar = document.querySelector('.navbar');
            var topnav = document.querySelector('.top-nav');
            var themeSwitcher = document.querySelector('.theme-switcher');
            var header = document.querySelector('.content-header');
            var contentWrapper = document.querySelector('.content-wrapper');
            var mainContainer = document.querySelector('.main-content-container');
            
            // 监听主题切换
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        var isDarkMode = document.documentElement.classList.contains('dark-theme');
                        var isFullScreen = document.body.classList.contains('CodeMirror-fullscreen-active');
                        
                        if (isFullScreen) {
                            // 应用全屏模式下的暗黑模式样式
                            if (isDarkMode) {
                                var editorElement = document.querySelector('.CodeMirror-fullscreen');
                                var toolbarElement = document.querySelector('.editor-toolbar.fullscreen');
                                
                                if (editorElement) {
                                    editorElement.style.backgroundColor = '#1a1a1a';
                                    editorElement.style.color = '#f8f9fa';
                                }
                                
                                if (toolbarElement) {
                                    toolbarElement.style.backgroundColor = '#1a1a1a';
                                    toolbarElement.style.borderBottom = '1px solid #2c2c2c';
                                }
                            }
                        }
                    }
                });
            });
            
            observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
            
            // 监听编辑器全屏模式
            simplemde.codemirror.on('fullScreen', function(cm, isFullScreen) {
                if (isFullScreen) {
                    // 添加全屏模式标识类
                    document.body.classList.add('CodeMirror-fullscreen-active');
                    document.documentElement.classList.add('CodeMirror-fullscreen-active');
                    
                    // 隐藏所有其他元素
                    if (sidebar) sidebar.style.display = 'none';
                    if (navbar) navbar.style.display = 'none';
                    if (topnav) topnav.style.display = 'none';
                    if (themeSwitcher) themeSwitcher.style.display = 'none';
                    if (header) header.style.display = 'none';
                    
                    // 确保所有z-index正确
                    if (sidebar) sidebar.style.zIndex = '-1';
                    if (navbar) navbar.style.zIndex = '-1';
                    if (topnav) topnav.style.zIndex = '-1';
                    if (header) header.style.zIndex = '-1';
                    
                    // 在短暂延迟后应用编辑器和工具栏样式
                    setTimeout(function() {
                        var isDarkMode = document.documentElement.classList.contains('dark-theme');
                        var editorElement = document.querySelector('.CodeMirror-fullscreen');
                        var toolbarElement = document.querySelector('.editor-toolbar.fullscreen');
                        var scrollElement = document.querySelector('.CodeMirror-fullscreen .CodeMirror-scroll');
                        
                        if (editorElement) {
                            // 确保编辑器可以滚动
                            editorElement.style.overflow = 'hidden';
                            editorElement.style.height = '100vh'; 
                            
                            if (isDarkMode) {
                                editorElement.style.backgroundColor = '#1a1a1a';
                                editorElement.style.color = '#f8f9fa';
                            } else {
                                editorElement.style.backgroundColor = '#fff';
                            }
                        }
                        
                        if (scrollElement) {
                            scrollElement.style.height = 'calc(100vh - 50px)';
                            scrollElement.style.maxHeight = 'calc(100vh - 50px)';
                            scrollElement.style.overflow = 'auto';
                            scrollElement.style.overflowY = 'scroll';
                            scrollElement.style.overflowX = 'auto';
                            scrollElement.style.display = 'block';
                            scrollElement.style.visibility = 'visible';
                            
                            // 强制滚动条显示
                            setTimeout(function() {
                                var scrollbarWidth = getScrollbarWidth();
                                // 设置右侧边距确保滚动条显示
                                scrollElement.style.width = 'calc(100% - ' + scrollbarWidth + 'px)';
                                scrollElement.style.paddingRight = scrollbarWidth + 'px';
                                
                                // 强制触发滚动事件以显示滚动条
                                scrollElement.scrollTop = 1;
                                setTimeout(function() {
                                    scrollElement.scrollTop = 0;
                                }, 10);
                            }, 200);
                        }
                        
                        if (toolbarElement) {
                            toolbarElement.style.width = '100%';
                            
                            if (isDarkMode) {
                                toolbarElement.style.backgroundColor = '#1a1a1a';
                                toolbarElement.style.borderBottom = '1px solid #2c2c2c';
                            } else {
                                toolbarElement.style.backgroundColor = '#fff';
                                toolbarElement.style.borderBottom = '1px solid #ddd';
                            }
                        }
                        
                        // 确保内容区域正确计算高度
                        var contentArea = editorElement.querySelector('.CodeMirror-sizer');
                        if (contentArea) {
                            contentArea.style.minHeight = 'calc(100vh - 50px)';
                        }
                        
                        // 强制浏览器重新计算布局
                        window.dispatchEvent(new Event('resize'));
                    }, 100);
                } else {
                    // 移除全屏模式标识类
                    document.body.classList.remove('CodeMirror-fullscreen-active');
                    document.documentElement.classList.remove('CodeMirror-fullscreen-active');
                    
                    // 恢复所有元素
                    if (sidebar) {
                        sidebar.style.display = '';
                        sidebar.style.zIndex = '';
                    }
                    
                    if (navbar) {
                        navbar.style.display = '';
                        navbar.style.zIndex = '';
                    }
                    
                    if (topnav) {
                        topnav.style.display = '';
                        topnav.style.zIndex = '';
                    }
                    
                    if (themeSwitcher) {
                        themeSwitcher.style.display = '';
                    }
                    
                    if (header) {
                        header.style.display = '';
                        header.style.zIndex = '';
                    }
                    
                    // 重置编辑器样式
                    var editorElement = document.querySelector('.CodeMirror');
                    if (editorElement) {
                        editorElement.style.height = '400px';
                    }
                    
                    // 强制浏览器重新计算布局
                    window.dispatchEvent(new Event('resize'));
                }
            });
        };

        // 在编辑器初始化后执行全屏处理逻辑
        simplemdeFullScreenHandler();
        
        // 监听主题切换
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    const isDark = document.documentElement.classList.contains('dark-theme');
                    const cmEditor = simplemde.codemirror;
                    const toolbar = document.querySelector('.editor-toolbar');
                    const preview = document.querySelector('.editor-preview-side');
                    
                    if (isDark) {
                        cmEditor.getWrapperElement().classList.add('cm-s-dark');
                        toolbar.classList.add('dark-theme');
                        preview.classList.add('dark-theme');
                    } else {
                        cmEditor.getWrapperElement().classList.remove('cm-s-dark');
                        toolbar.classList.remove('dark-theme');
                        preview.classList.remove('dark-theme');
                    }
                }
            });
        });
        
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
        
        // 显示自定义通知函数
        function showCustomNotification(message, type) {
            // 获取或创建通知容器
            let container = document.getElementById('custom-notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'custom-notification-container';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.style.minWidth = '300px';
            notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            notification.style.marginBottom = '10px';
            notification.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            
            // 添加关闭按钮
            notification.innerHTML = `
                <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
                <span>${message}</span>
            `;
            
            // 添加到容器
            container.appendChild(notification);
            
            // 触发动画
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 10);
            
            // 自动关闭
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }
        
        // 处理直接提交按钮事件
        document.getElementById('direct-submit-btn').addEventListener('click', function() {
            // 将SimpleMDE的内容同步到原始textarea
            var content = simplemde.value();
            
            // 如果内容为空，显示错误
            if (!content.trim()) {
                alert('文章内容不能为空');
                return;
            }
            
            document.getElementById('content').value = content;
            
            // 显示textarea确保内容被提交
            document.getElementById('content').style.display = 'block';
            
            // 直接提交表单
            var submitButton = document.querySelector('form .btn-primary[type="submit"]');
            if(submitButton) {
                submitButton.click();
            } else {
                document.getElementById('post-form').submit();
            }
        });
        
        // 表单提交前处理
        document.getElementById('post-form').addEventListener('submit', function(e) {
            // 将编辑器内容同步到textarea
            var content = simplemde.value();
            document.getElementById('content').value = content;
            document.getElementById('content').style.display = 'block';
            
            // 如果内容为空，阻止表单提交并显示错误
            if (!content.trim()) {
                e.preventDefault();
                alert('文章内容不能为空');
                return false;
            }
            
            // 正常提交表单
            return true;
        });

        // 获取浏览器滚动条宽度
        function getScrollbarWidth() {
            var outer = document.createElement("div");
            outer.style.visibility = "hidden";
            outer.style.overflow = "scroll";
            document.body.appendChild(outer);
            
            var inner = document.createElement("div");
            outer.appendChild(inner);
            
            var scrollbarWidth = outer.offsetWidth - inner.offsetWidth;
            outer.parentNode.removeChild(outer);
            
            return scrollbarWidth;
        }
});
</script>
{% endblock %} 