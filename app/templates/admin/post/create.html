{% extends 'admin/base.html' %}

{% block title %}写文章 - 管理后台{% endblock %}

{% block page_title %}写文章{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css" rel="stylesheet" />
<style>
    .CodeMirror {
        height: 400px;
    }
    .editor-toolbar {
        border-radius: 0;
    }
    .form-check-input {
        margin-top: 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Flash消息容器 -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-container" style="display: none;">
            {% for category, message in messages %}
                <div class="flash-message" data-category="{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="card">
    <div class="card-body">
        <form method="post" action="{{ url_for('admin_dashboard.post.create') }}" id="post-form">
            <div class="mb-3">
                {{ form.title.label(class="form-label") }}
                {{ form.title(class="form-control") }}
                {% if form.title.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.title.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                {{ form.content.label(class="form-label") }}
                {{ form.content(class="form-control", rows=10, style="visibility: hidden; position: absolute;") }}
                {% if form.content.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.content.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">支持 Markdown 格式</div>
            </div>
            
            <div class="mb-3">
                {{ form.summary.label(class="form-label") }}
                {{ form.summary(class="form-control", rows=3) }}
                {% if form.summary.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.summary.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">如果不填写，将自动截取正文前 150 个字符作为摘要</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.category_id.label(class="form-label") }}
                        {{ form.category_id(class="form-select") }}
                        {% if form.category_id.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.category_id.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.status.label(class="form-label") }}
                        {{ form.status(class="form-select") }}
                        {% if form.status.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.status.errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                {{ form.tags.label(class="form-label") }}
                {{ form.tags(class="form-select", multiple=True) }}
                {% if form.tags.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.tags.errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">可以选择多个标签，也可以输入新标签</div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="form-check">
                        {{ form.is_sticky(class="form-check-input") }}
                        {{ form.is_sticky.label(class="form-check-label") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        {{ form.is_private(class="form-check-input") }}
                        {{ form.is_private.label(class="form-check-label") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check">
                        {{ form.can_comment(class="form-check-input") }}
                        {{ form.can_comment.label(class="form-check-label") }}
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('admin_dashboard.post.index') }}" class="btn btn-secondary">取消</a>
                <div>
                    <button type="button" id="direct-submit-btn" class="btn btn-success me-2">直接提交</button>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化 Select2
        $('#tags').select2({
            theme: 'bootstrap-5',
            placeholder: '选择或输入标签',
            allowClear: true,
            tags: true,
            tokenSeparators: [',', ' '],
            width: '100%'
        });
        
        // 初始化 SimpleMDE
        var simplemde = new SimpleMDE({
            element: document.getElementById("content"),
            spellChecker: false,
            autosave: {
                enabled: true,
                uniqueId: "post-create",
                delay: 1000,
            },
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                "link", "image", "table", "code", "|",
                "preview", "side-by-side", "fullscreen", "|",
                "guide"
            ]
        });
        
        // 处理直接提交按钮事件
        document.getElementById('direct-submit-btn').addEventListener('click', function() {
            // 将SimpleMDE的内容同步到原始textarea
            var content = simplemde.value();
            
            // 如果内容为空，显示错误
            if (!content.trim()) {
                showCustomNotification('文章内容不能为空', 'error');
                return;
            }
            
            document.getElementById('content').value = content;
            console.log('直接提交 - 内容已同步到表单，长度:', content.length);
            
            // 显示textarea确保内容被提交
            document.getElementById('content').style.display = 'block';
            
            // 直接提交表单
            console.log('直接提交表单...');
            // 查找表单中的原生提交按钮并点击它
            var submitButton = document.querySelector('form .btn-primary[type="submit"]');
            if(submitButton) {
                submitButton.click();
            } else {
                // 后备方案：直接提交表单
                document.getElementById('post-form').submit();
            }
        });
        
        // 表单提交前处理 - 简化版
        document.getElementById('post-form').addEventListener('submit', function(e) {
            // 将编辑器内容同步到textarea
            var content = simplemde.value();
            document.getElementById('content').value = content;
            document.getElementById('content').style.display = 'block';
            
            // 如果内容为空，阻止表单提交并显示错误
            if (!content.trim()) {
                e.preventDefault();
                showCustomNotification('文章内容不能为空', 'error');
                return false;
            }
            
            // 正常提交表单
            return true;
        });
        
        // 显示Flash消息
        const flashMessages = document.querySelectorAll('.flash-message');
        if (flashMessages.length > 0) {
            flashMessages.forEach(function(message) {
                const type = message.dataset.category === 'success' ? 'success' : 'error';
                const text = message.textContent;
                showCustomNotification(text, type);
            });
        }
        
        // 自定义通知显示函数
        function showCustomNotification(message, type) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'custom-notification alert alert-' + (type === 'success' ? 'success' : 'danger');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '300px';
            
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>${message}</div>
                    <button type="button" class="btn-close" aria-label="关闭"></button>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 添加关闭按钮事件
            notification.querySelector('.btn-close').addEventListener('click', function() {
                document.body.removeChild(notification);
            });
            
            // 5秒后自动关闭
            setTimeout(function() {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }
    });
</script>
{% endblock %} 